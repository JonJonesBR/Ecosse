<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout System Test</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/layout-configuration.css">
    <style>
        /* Test-specific styles */
        .test-results {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            z-index: 9999;
        }
        
        .test-pass { color: #4ade80; }
        .test-fail { color: #f87171; }
        
        /* Ensure proper flex layout structure */
        #app-container {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100vh;
            overflow: hidden;
            min-width: 0;
        }
        
        #three-js-canvas-container {
            flex: 1;
            position: relative;
            min-height: 300px;
            background: #1e293b;
        }
        
        .panel {
            width: 280px;
            flex-shrink: 0;
            background: rgba(15, 23, 42, 0.95);
            padding: 1rem;
            height: 100vh;
            overflow-y: auto;
        }
        
        #top-panel {
            background: rgba(30, 41, 59, 0.9);
            padding: 1rem;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #bottom-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            padding: 1rem;
            border-radius: 8px;
            max-width: 80vw;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="test-results" class="test-results">
        <div>Running layout tests...</div>
    </div>

    <div id="app-container">
        <div id="left-panel" class="panel">
            <h3>Left Panel</h3>
            <p>Configuration content here</p>
        </div>

        <main id="main-content">
            <div id="top-panel">
                <h1>Ecosse™ - Layout Test</h1>
            </div>

            <div id="three-js-canvas-container">
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white;">
                    Canvas Area (should maximize available space)
                </div>
            </div>
        </main>

        <div id="right-panel" class="panel">
            <h3>Right Panel</h3>
            <p>Information content here</p>
        </div>
    </div>

    <div id="bottom-panel">
        <h3>Floating Controls</h3>
        <p>This should float and not obstruct the canvas</p>
    </div>

    <script type="module">
        // Mock the required systems for testing
        window.layoutManager = {
            viewportSize: { width: window.innerWidth, height: window.innerHeight },
            panelStates: { left: 'visible', right: 'visible', controls: 'floating' },
            breakpoints: { mobile: 768, tablet: 1024, desktop: 1440 },
            
            getLayoutInfo() {
                return {
                    viewportSize: this.viewportSize,
                    panelStates: this.panelStates,
                    layoutConfig: {
                        panels: {
                            left: { width: 280 },
                            right: { width: 280 }
                        },
                        canvas: { minWidth: 400, minHeight: 300 }
                    }
                };
            },
            
            getViewportType() {
                const width = this.viewportSize.width;
                if (width <= this.breakpoints.mobile) return 'mobile';
                if (width <= this.breakpoints.tablet) return 'tablet';
                return 'desktop';
            },
            
            togglePanel(panelName) {
                const currentState = this.panelStates[panelName];
                this.panelStates[panelName] = currentState === 'visible' ? 'hidden' : 'visible';
                return true;
            },
            
            updateLayout() {
                // Mock implementation
                return true;
            },
            
            notifyLayoutChange() {
                document.dispatchEvent(new CustomEvent('layoutChanged', {
                    detail: this.getLayoutInfo()
                }));
            },
            
            addLayoutChangeListener(callback) {
                document.addEventListener('layoutChanged', callback);
            },
            
            removeLayoutChangeListener(callback) {
                document.removeEventListener('layoutChanged', callback);
            }
        };

        window.responsiveBreakpoints = {
            getCurrentBreakpoint() {
                return window.layoutManager.getViewportType();
            },
            getDebugInfo() {
                return { currentBreakpoint: this.getCurrentBreakpoint() };
            }
        };

        window.viewportMonitor = {
            getViewportDimensions() {
                return { width: window.innerWidth, height: window.innerHeight };
            },
            getDebugInfo() {
                return this.getViewportDimensions();
            }
        };

        window.coreLayoutSystem = {
            getCurrentLayout() {
                return window.layoutManager.getLayoutInfo();
            },
            getDebugInfo() {
                return { initialized: true };
            },
            getPerformanceMetrics() {
                return { renderTime: 16, layoutTime: 2 };
            }
        };

        window.responsiveCanvasContainer = {
            setAutoResize(enabled) {
                console.log('setAutoResize called with:', enabled);
                return true;
            }
        };

        // Import and run the layout tests
        Promise.all([
            import('./js/test-layout-system.js'),
            import('./js/test-layout-fixes-verification.js')
        ]).then(([layoutModule, fixesModule]) => {
            const testResults = document.getElementById('test-results');
            
            try {
                // Run original layout system tests
                const layoutResult = layoutModule.testLayoutSystem();
                
                // Run layout fixes verification tests
                const fixesResult = fixesModule.runAllLayoutFixesTests();
                
                let html = `<div><strong>Layout System Tests</strong></div>`;
                html += `<div>Total: ${layoutResult.totalTests}, Passed: ${layoutResult.passedTests}</div>`;
                html += `<div>Pass Rate: ${layoutResult.passRate}%</div><br>`;
                
                layoutResult.results.forEach(test => {
                    const status = test.passed ? 'test-pass' : 'test-fail';
                    const icon = test.passed ? '✅' : '❌';
                    html += `<div class="${status}">${icon} ${test.name}</div>`;
                    if (test.error) {
                        html += `<div style="font-size: 10px; color: #fbbf24;">  ${test.error}</div>`;
                    }
                });
                
                html += `<br><div><strong>Layout Fixes Tests</strong></div>`;
                html += `<div>Total: ${fixesResult.totalTests}, Passed: ${fixesResult.totalPassed}</div>`;
                html += `<div>Pass Rate: ${fixesResult.overallPassRate}%</div><br>`;
                
                // Show fixes test results
                fixesResult.fixesResult.results.forEach(test => {
                    const status = test.passed ? 'test-pass' : 'test-fail';
                    const icon = test.passed ? '✅' : '❌';
                    html += `<div class="${status}">${icon} ${test.name}</div>`;
                    if (test.error) {
                        html += `<div style="font-size: 10px; color: #fbbf24;">  ${test.error}</div>`;
                    }
                });
                
                testResults.innerHTML = html;
                
                // Also log to console
                console.log('Layout test results:', layoutResult);
                console.log('Layout fixes results:', fixesResult);
                
            } catch (error) {
                testResults.innerHTML = `<div class="test-fail">❌ Test failed: ${error.message}</div>`;
                console.error('Test error:', error);
            }
        }).catch(error => {
            document.getElementById('test-results').innerHTML = `<div class="test-fail">❌ Failed to load tests: ${error.message}</div>`;
            console.error('Import error:', error);
        });

        // Test the actual layout structure
        function testLayoutStructure() {
            const tests = [];
            
            // Test 1: App container has proper flex layout
            const appContainer = document.getElementById('app-container');
            tests.push({
                name: 'App Container Flex Layout',
                passed: appContainer && 
                       window.getComputedStyle(appContainer).display === 'flex' &&
                       window.getComputedStyle(appContainer).flexDirection === 'row'
            });
            
            // Test 2: Main content has proper flex column layout
            const mainContent = document.getElementById('main-content');
            tests.push({
                name: 'Main Content Flex Column',
                passed: mainContent && 
                       window.getComputedStyle(mainContent).display === 'flex' &&
                       window.getComputedStyle(mainContent).flexDirection === 'column'
            });
            
            // Test 3: Canvas container maximizes available space
            const canvasContainer = document.getElementById('three-js-canvas-container');
            tests.push({
                name: 'Canvas Container Flex Growth',
                passed: canvasContainer && 
                       window.getComputedStyle(canvasContainer).flex.includes('1')
            });
            
            // Test 4: Bottom panel is positioned as floating
            const bottomPanel = document.getElementById('bottom-panel');
            tests.push({
                name: 'Bottom Panel Floating Position',
                passed: bottomPanel && 
                       window.getComputedStyle(bottomPanel).position === 'fixed'
            });
            
            // Test 5: Canvas area has proper height utilization
            const canvasHeight = canvasContainer ? canvasContainer.offsetHeight : 0;
            const viewportHeight = window.innerHeight;
            const heightUtilization = (canvasHeight / viewportHeight) * 100;
            tests.push({
                name: 'Canvas Height Utilization (>70%)',
                passed: heightUtilization > 70
            });
            
            return tests;
        }
        
        // Run structure tests after a delay
        setTimeout(() => {
            const structureTests = testLayoutStructure();
            const testResults = document.getElementById('test-results');
            let currentHTML = testResults.innerHTML;
            
            currentHTML += `<br><div><strong>Layout Structure Tests</strong></div>`;
            
            structureTests.forEach(test => {
                const status = test.passed ? 'test-pass' : 'test-fail';
                const icon = test.passed ? '✅' : '❌';
                currentHTML += `<div class="${status}">${icon} ${test.name}</div>`;
            });
            
            testResults.innerHTML = currentHTML;
            console.log('Structure test results:', structureTests);
        }, 1000);
    </script>
</body>
</html>