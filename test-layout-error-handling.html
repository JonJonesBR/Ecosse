<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Layout Error Handling - Task 6</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .test-results {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(55, 65, 81, 0.5);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-healthy { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-critical { background: #ef4444; }
        .status-degraded { background: #8b5cf6; }
        h1, h2 { color: #60a5fa; }
        .info-panel {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 6px 6px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Layout Error Handling Test - Task 6</h1>
        
        <div class="info-panel">
            <h3>Task 6: Add layout error handling and recovery</h3>
            <p>This page tests the implementation of comprehensive layout error handling including:</p>
            <ul>
                <li><strong>5.1:</strong> Error detection for missing DOM elements</li>
                <li><strong>5.2:</strong> Fallback layout mechanisms</li>
                <li><strong>5.3:</strong> Graceful degradation for CSS conflicts</li>
                <li><strong>5.4:</strong> Layout error recovery</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>System Status</h2>
            <div id="system-status">
                <p>Loading system status...</p>
            </div>
            <button class="test-button" onclick="updateSystemStatus()">Refresh Status</button>
        </div>

        <div class="test-section">
            <h2>Error Detection Tests</h2>
            <p>Test the error detection and recovery mechanisms:</p>
            <button class="test-button" onclick="runBasicTests()">Run Basic Tests</button>
            <button class="test-button" onclick="runComprehensiveTests()">Run Comprehensive Tests</button>
            <button class="test-button" onclick="runSpecificScenarios()">Test Specific Scenarios</button>
            <button class="test-button" onclick="validateRequirements()">Validate Requirements</button>
            <div class="test-results" id="test-results">
                Test results will appear here...
            </div>
        </div>

        <div class="test-section">
            <h2>Error Simulation</h2>
            <p>Simulate various error conditions to test recovery:</p>
            <button class="test-button" onclick="simulateMissingElement()">Simulate Missing Element</button>
            <button class="test-button" onclick="simulateCSSConflict()">Simulate CSS Conflict</button>
            <button class="test-button" onclick="simulateResizeError()">Simulate Resize Error</button>
            <button class="test-button" onclick="triggerFallbackLayout()">Trigger Fallback Layout</button>
            <div class="test-results" id="simulation-results">
                Simulation results will appear here...
            </div>
        </div>

        <div class="test-section">
            <h2>System Diagnostics</h2>
            <button class="test-button" onclick="showDiagnostics()">Show Diagnostics</button>
            <button class="test-button" onclick="runHealthCheck()">Run Health Check</button>
            <button class="test-button" onclick="resetErrorHandler()">Reset Error Handler</button>
            <div class="test-results" id="diagnostics-results">
                Diagnostics will appear here...
            </div>
        </div>
    </div>

    <!-- Include the layout error handler -->
    <script type="module">
        // Import the layout error handler
        import { layoutErrorHandler } from './js/ui/layoutErrorHandler.js';
        import { testLayoutErrorHandling, testSpecificErrorScenarios, validateErrorHandlingRequirements } from './js/test-layout-error-handling.js';
        import { verifyLayoutErrorHandling, runComprehensiveErrorTests } from './js/verify-layout-error-handling.js';

        // Make available globally
        window.layoutErrorHandler = layoutErrorHandler;
        window.testLayoutErrorHandling = testLayoutErrorHandling;
        window.testSpecificErrorScenarios = testSpecificErrorScenarios;
        window.validateErrorHandlingRequirements = validateErrorHandlingRequirements;
        window.verifyLayoutErrorHandling = verifyLayoutErrorHandling;
        window.runComprehensiveErrorTests = runComprehensiveErrorTests;

        // Initialize system status
        updateSystemStatus();

        console.log('üîß Layout Error Handling test page loaded');
        console.log('Available functions: testLayoutErrorHandling(), verifyLayoutErrorHandling(), runComprehensiveErrorTests()');
    </script>

    <script>
        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            
            if (!window.layoutErrorHandler) {
                statusDiv.innerHTML = '<p style="color: #ef4444;">‚ùå Layout Error Handler not available</p>';
                return;
            }

            try {
                const status = window.layoutErrorHandler.getStatus();
                const health = window.layoutErrorHandler.getSystemHealth();
                const diagnostics = window.layoutErrorHandler.getDiagnostics();

                let healthColor = 'status-healthy';
                switch(health) {
                    case 'warning': healthColor = 'status-warning'; break;
                    case 'critical': healthColor = 'status-critical'; break;
                    case 'degraded': healthColor = 'status-degraded'; break;
                }

                statusDiv.innerHTML = `
                    <p><span class="status-indicator ${healthColor}"></span><strong>System Health:</strong> ${health}</p>
                    <p><strong>Error Count:</strong> ${status.errorCount}</p>
                    <p><strong>Missing Elements:</strong> ${status.missingElements.length}</p>
                    <p><strong>CSS Conflicts:</strong> ${status.cssConflicts.length}</p>
                    <p><strong>Recovery Attempts:</strong> ${status.recoveryAttempts}/${status.maxRecoveryAttempts}</p>
                    <p><strong>Monitoring Active:</strong> ${status.monitoringActive ? '‚úÖ' : '‚ùå'}</p>
                    <p><strong>Fallback Applied:</strong> ${status.fallbackApplied ? '‚úÖ' : '‚ùå'}</p>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<p style="color: #ef4444;">‚ùå Error getting status: ${error.message}</p>`;
            }
        }

        function runBasicTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = 'Running basic tests...\n';
            
            try {
                const results = window.testLayoutErrorHandling();
                resultsDiv.innerHTML = formatTestResults(results);
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Test failed: ${error.message}`;
            }
        }

        function runComprehensiveTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = 'Running comprehensive tests...\n';
            
            try {
                const success = window.runComprehensiveErrorTests();
                resultsDiv.innerHTML = `Comprehensive tests ${success ? 'PASSED' : 'FAILED'}\nCheck console for details.`;
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Test failed: ${error.message}`;
            }
        }

        function runSpecificScenarios() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = 'Running specific error scenarios...\n';
            
            try {
                const success = window.testSpecificErrorScenarios();
                resultsDiv.innerHTML = `Specific scenarios ${success ? 'PASSED' : 'FAILED'}\nCheck console for details.`;
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Test failed: ${error.message}`;
            }
        }

        function validateRequirements() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = 'Validating requirements...\n';
            
            try {
                const verification = window.verifyLayoutErrorHandling();
                resultsDiv.innerHTML = formatVerificationResults(verification);
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Validation failed: ${error.message}`;
            }
        }

        function simulateMissingElement() {
            const resultsDiv = document.getElementById('simulation-results');
            
            try {
                // Create and remove an element to simulate missing
                const testEl = document.createElement('div');
                testEl.id = 'simulated-missing-element';
                document.body.appendChild(testEl);
                testEl.remove();
                
                // Trigger detection
                window.layoutErrorHandler.detectMissingElements(['simulated-missing-element']);
                
                resultsDiv.innerHTML = '‚úÖ Missing element simulation triggered\nCheck system status for updates.';
                setTimeout(updateSystemStatus, 1000);
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Simulation failed: ${error.message}`;
            }
        }

        function simulateCSSConflict() {
            const resultsDiv = document.getElementById('simulation-results');
            
            try {
                // Create element with CSS conflicts
                const testEl = document.createElement('div');
                testEl.id = 'css-conflict-simulation';
                testEl.style.display = 'none';
                testEl.style.width = '0px';
                testEl.style.height = '0px';
                document.body.appendChild(testEl);
                
                // Trigger conflict detection
                window.layoutErrorHandler.checkForCSSConflicts(testEl);
                
                resultsDiv.innerHTML = '‚úÖ CSS conflict simulation triggered\nCheck system status for updates.';
                setTimeout(() => {
                    testEl.remove();
                    updateSystemStatus();
                }, 2000);
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Simulation failed: ${error.message}`;
            }
        }

        function simulateResizeError() {
            const resultsDiv = document.getElementById('simulation-results');
            
            try {
                // Simulate resize error
                const fakeError = new Error('Simulated resize error');
                window.layoutErrorHandler.handleResizeError(fakeError, 'test-simulation');
                
                resultsDiv.innerHTML = '‚úÖ Resize error simulation triggered\nCheck system status for updates.';
                setTimeout(updateSystemStatus, 1000);
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Simulation failed: ${error.message}`;
            }
        }

        function triggerFallbackLayout() {
            const resultsDiv = document.getElementById('simulation-results');
            
            try {
                // Force fallback layout
                window.layoutErrorHandler.applyFallbackLayout();
                
                resultsDiv.innerHTML = '‚úÖ Fallback layout triggered\nCheck system status for updates.';
                setTimeout(updateSystemStatus, 1000);
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Simulation failed: ${error.message}`;
            }
        }

        function showDiagnostics() {
            const resultsDiv = document.getElementById('diagnostics-results');
            
            try {
                const diagnostics = window.layoutErrorHandler.getDiagnostics();
                resultsDiv.innerHTML = formatDiagnostics(diagnostics);
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Diagnostics failed: ${error.message}`;
            }
        }

        function runHealthCheck() {
            const resultsDiv = document.getElementById('diagnostics-results');
            
            try {
                const checkResults = window.layoutErrorHandler.runComprehensiveCheck();
                resultsDiv.innerHTML = formatHealthCheck(checkResults);
                setTimeout(updateSystemStatus, 1000);
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Health check failed: ${error.message}`;
            }
        }

        function resetErrorHandler() {
            const resultsDiv = document.getElementById('diagnostics-results');
            
            try {
                window.layoutErrorHandler.reset();
                resultsDiv.innerHTML = '‚úÖ Error handler reset successfully';
                setTimeout(updateSystemStatus, 500);
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå Reset failed: ${error.message}`;
            }
        }

        function formatTestResults(results) {
            let output = `Test Results (${new Date(results.timestamp).toLocaleTimeString()})\n`;
            output += `Passed: ${results.summary.passed}/${results.summary.total}\n\n`;
            
            results.tests.forEach(test => {
                const status = test.passed ? '‚úÖ' : '‚ùå';
                output += `${status} ${test.name}\n`;
                if (test.details) {
                    output += `   ${test.details}\n`;
                }
            });
            
            return output;
        }

        function formatVerificationResults(verification) {
            let output = `Verification Results\n`;
            output += `Success Rate: ${verification.summary.successRate.toFixed(1)}%\n\n`;
            
            Object.entries(verification.requirements).forEach(([id, req]) => {
                const status = req.passed ? '‚úÖ' : '‚ùå';
                output += `${status} ${id}: ${req.description}\n`;
                if (req.details) {
                    output += `   ${req.details}\n`;
                }
            });
            
            return output;
        }

        function formatDiagnostics(diagnostics) {
            let output = `System Diagnostics\n`;
            output += `Health: ${diagnostics.summary.systemHealth}\n`;
            output += `Total Errors: ${diagnostics.summary.totalErrors}\n`;
            output += `Critical Issues: ${diagnostics.summary.criticalIssues}\n\n`;
            
            if (diagnostics.recommendations.length > 0) {
                output += `Recommendations:\n`;
                diagnostics.recommendations.forEach(rec => {
                    output += `‚Ä¢ ${rec}\n`;
                });
            }
            
            return output;
        }

        function formatHealthCheck(results) {
            let output = `Health Check Results\n`;
            output += `Timestamp: ${new Date(results.timestamp).toLocaleString()}\n`;
            output += `Previous Errors: ${results.previousErrorCount}\n`;
            output += `New Errors: ${results.newErrorCount}\n\n`;
            
            if (results.actionsTaken.length > 0) {
                output += `Actions Taken:\n`;
                results.actionsTaken.forEach(action => {
                    output += `‚Ä¢ ${action}\n`;
                });
            }
            
            return output;
        }
    </script>
</body>
</html>